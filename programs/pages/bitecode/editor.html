<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Code editor - Bitecode</title>

<style>
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Helvetica,Arial,sans-serif;
  background:#f6f8fa;
  font-size:14px;
  color:#24292f;
  display:flex;
  flex-direction:column;
  height:100vh;
}

.global-header{
  background:#24292f;
  color:#fff;
  height:56px;
  display:flex;
  align-items:center;
  padding:0 16px;
  font-weight:600;
  flex-shrink:0;
}

.breadcrumb{
  background:#fff;
  padding:12px 24px;
  border-bottom:1px solid #d0d7de;
  flex-shrink:0;
}

.code-wrapper{
  margin:24px;
  border:1px solid #d0d7de;
  border-radius:6px;
  background:#fff;
  overflow:hidden;
  display:flex;
  flex-direction:column;
  flex:1;
}

.code-header{
  background:#f6f8fa;
  padding:8px 16px;
  border-bottom:1px solid #d0d7de;
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-size:12px;
  color:#57606a;
  flex-shrink:0;
}

.header-left{
  display:flex;
  gap:16px;
  align-items:center;
}

.header-right{
  display:flex;
  gap:12px;
  align-items:center;
}

button{
  padding:4px 10px;
  font-size:12px;
  border:1px solid #d0d7de;
  border-radius:6px;
  background:#fff;
  cursor:pointer;
}

button:hover{
  background:#f3f4f6;
}

.code-area{
  display:flex;
  font-family:ui-monospace,SFMono-Regular,Consolas,"Liberation Mono",Menlo,monospace;
  font-size:13px;
  flex:1;
  overflow:hidden;
}

.line-numbers{
  background:#f6f8fa;
  padding:10px 8px;
  text-align:right;
  user-select:none;
  color:#57606a;
  overflow:hidden;
  line-height:1.6;
}

pre{
  margin:0;
  padding:10px;
  overflow:auto;
  white-space:pre;
  flex:1;
  line-height:1.6;
}
</style>
</head>
<body>

<div class="global-header">
  Bite code
</div>

<div class="breadcrumb" id="filePath">
  Loading...
</div>

<div class="code-wrapper">

  <div class="code-header">
    <div class="header-left">
      <div id="lineCount">0 lines</div>
      <div id="fileInfo">0 chars | 0 KB</div>
    </div>

    <div class="header-right">
      <button id="downloadBtn">Download</button>
    </div>
  </div>

  <div class="code-area">
    <div class="line-numbers" id="lineNumbers"></div>
    <pre id="codeDisplay"></pre>
  </div>

</div>

<script>
const lineNumbers = document.getElementById("lineNumbers");
const lineCount = document.getElementById("lineCount");
const fileInfo = document.getElementById("fileInfo");
const codeDisplay = document.getElementById("codeDisplay");
const filePathDisplay = document.getElementById("filePath");
const downloadBtn = document.getElementById("downloadBtn");

/* ホワイトリスト指定 */
const allowedFiles = [
  "index.html",
  "README_Catmakura.md",
  "app.js",
  "style.css",
  "folder/test.js"
];

let currentText = "";
let currentFileName = "";

const params = new URLSearchParams(window.location.search);
currentFileName = params.get("file") || "sample.html";

/* ホワイトリスト判定 */
if(!allowedFiles.includes(currentFileName)){
  showError("403 - Access denied.");
} else {
  loadFile(currentFileName);
}

function loadFile(fileName){
  filePathDisplay.textContent = fileName;

  fetch(fileName)
    .then(res => {
      if(!res.ok) throw new Error("404 - File not found");
      return res.text();
    })
    .then(text => {
      currentText = text;
      codeDisplay.textContent = text;
      generateLines(text);

      // タイトル変更
      document.title = fileName + " - Bite code";
    })
    .catch(() => {
      showError("File not found.");
    });
}

function showError(message){
  codeDisplay.textContent = message;
  lineNumbers.innerHTML = "";
  lineCount.textContent = "0 lines";
  fileInfo.textContent = "";
  downloadBtn.disabled = true;

  // タイトル変更
  document.title = "error - Bite code";
}

function generateLines(text){
  const lines = text.split("\n");
  lineNumbers.innerHTML = lines.map((_,i)=> i+1).join("<br>");
  lineCount.textContent = lines.length + " lines";

  const charCount = text.length;
  const byteSize = new Blob([text]).size;

  let sizeDisplay;
  if(byteSize < 1024){
    sizeDisplay = byteSize + " B";
  } else if(byteSize < 1024 * 1024){
    sizeDisplay = (byteSize / 1024).toFixed(2) + " KB";
  } else {
    sizeDisplay = (byteSize / (1024 * 1024)).toFixed(2) + " MB";
  }

  fileInfo.textContent = `${charCount} chars | ${sizeDisplay}`;
}

codeDisplay.addEventListener("scroll",()=>{
  lineNumbers.scrollTop = codeDisplay.scrollTop;
});

downloadBtn.addEventListener("click", () => {
  if(!currentText) return;

  const blob = new Blob([currentText], { type: "text/plain" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = currentFileName;
  document.body.appendChild(a);
  a.click();

  document.body.removeChild(a);
  URL.revokeObjectURL(url);
});
</script>

</body>
</html>
